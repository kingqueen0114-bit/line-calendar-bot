<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨ºæ–­ãƒšãƒ¼ã‚¸ - LINE Calendar Bot</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      line-height: 1.6;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #06c755;
      margin-bottom: 20px;
      font-size: 24px;
    }
    h2 {
      color: #333;
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 18px;
      padding-bottom: 8px;
      border-bottom: 2px solid #06c755;
    }
    .status {
      margin: 10px 0;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #ccc;
    }
    .status.success {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    .status.error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .status.warning {
      background: #fff3e0;
      border-left-color: #ff9800;
    }
    .label {
      font-weight: bold;
      color: #666;
      margin-right: 8px;
    }
    .value {
      color: #333;
      font-family: 'Courier New', monospace;
    }
    button {
      background: #06c755;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px 10px 0;
    }
    button:hover {
      background: #05b34a;
    }
    button:active {
      transform: scale(0.98);
    }
    .btn-danger {
      background: #f44336;
    }
    .btn-danger:hover {
      background: #da190b;
    }
    pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ” è¨ºæ–­ãƒšãƒ¼ã‚¸</h1>
    <p>ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦å•é¡Œã‚’ç‰¹å®šã—ã¾ã™ã€‚</p>

    <h2>1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</h2>
    <div class="status" id="version-status">
      <div><span class="label">ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</span><span class="value" id="current-version">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ä¿å­˜ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³:</span><span class="value" id="stored-version">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è‡´:</span><span class="value" id="version-match">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>

    <h2>2. LIFF èªè¨¼çŠ¶æ…‹</h2>
    <div class="status" id="liff-status">
      <div><span class="label">LIFFåˆæœŸåŒ–:</span><span class="value" id="liff-init">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹:</span><span class="value" id="liff-login">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</span><span class="value" id="user-id">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</span><span class="value" id="user-name">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>

    <h2>3. APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
    <div class="status" id="api-status">
      <div><span class="label">API Base URL:</span><span class="value" id="api-base">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆAPI:</span><span class="value" id="api-events">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¹ã‚¯API:</span><span class="value" id="api-tasks">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒ¡ãƒ¢API:</span><span class="value" id="api-memos">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>

    <h2>4. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿çŠ¶æ…‹</h2>
    <div class="status" id="data-status">
      <div><span class="label">ã‚¤ãƒ™ãƒ³ãƒˆæ•°:</span><span class="value" id="events-count">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ã‚¿ã‚¹ã‚¯æ•°:</span><span class="value" id="tasks-count">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><span class="label">ãƒ¡ãƒ¢æ•°:</span><span class="value" id="memos-count">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>

    <h2>5. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</h2>
    <div class="status" id="error-status">
      <pre id="error-log">ã‚¨ãƒ©ãƒ¼ãªã—</pre>
    </div>

    <h2>6. æ“ä½œ</h2>
    <button onclick="clearStorageAndReload()">LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿</button>
    <button onclick="testAPIs()">APIæ¥ç¶šã‚’å†ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="copyDiagnostics()" class="btn-danger">è¨ºæ–­çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
  </div>

  <script>
    const LIFF_ID = '2006593633-7jp4ogp0';
    const API_BASE = window.location.origin;

    let userId = null;
    let errors = [];

    // ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    window.onerror = function(msg, url, line, col, error) {
      const errorMsg = `${msg} (${url}:${line}:${col})`;
      errors.push(errorMsg);
      updateErrorLog();
      return false;
    };

    async function init() {
      try {
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
        const currentVersion = window.APP_VERSION || 'ä¸æ˜';
        const storedVersion = localStorage.getItem('app_version') || 'æœªä¿å­˜';
        const versionMatch = currentVersion === storedVersion ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´';

        document.getElementById('current-version').textContent = currentVersion;
        document.getElementById('stored-version').textContent = storedVersion;
        document.getElementById('version-match').textContent = versionMatch;

        const versionStatus = document.getElementById('version-status');
        versionStatus.className = currentVersion === storedVersion ? 'status success' : 'status warning';

        // API Base
        document.getElementById('api-base').textContent = API_BASE;

        // LIFFåˆæœŸåŒ–
        document.getElementById('liff-init').textContent = 'åˆæœŸåŒ–ä¸­...';
        await liff.init({ liffId: LIFF_ID });
        document.getElementById('liff-init').textContent = 'âœ… æˆåŠŸ';

        const isLoggedIn = liff.isLoggedIn();
        document.getElementById('liff-login').textContent = isLoggedIn ? 'âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'âŒ æœªãƒ­ã‚°ã‚¤ãƒ³';

        const liffStatus = document.getElementById('liff-status');

        if (isLoggedIn) {
          const profile = await liff.getProfile();
          userId = profile.userId;
          document.getElementById('user-id').textContent = userId;
          document.getElementById('user-name').textContent = profile.displayName;
          liffStatus.className = 'status success';

          // API ãƒ†ã‚¹ãƒˆ
          await testAPIs();
        } else {
          document.getElementById('user-id').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
          document.getElementById('user-name').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
          liffStatus.className = 'status error';

          document.getElementById('api-events').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
          document.getElementById('api-tasks').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
          document.getElementById('api-memos').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
          document.getElementById('events-count').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
          document.getElementById('tasks-count').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
          document.getElementById('memos-count').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦';
        }

      } catch (error) {
        errors.push('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateErrorLog();
        document.getElementById('liff-init').textContent = 'âŒ å¤±æ•—: ' + error.message;
        document.getElementById('liff-status').className = 'status error';
      }
    }

    async function testAPIs() {
      if (!userId) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
        return;
      }

      try {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
        const eventsResponse = await fetch(`${API_BASE}/api/local-events?userId=${userId}&_t=${Date.now()}`, { cache: 'no-store' });
        if (eventsResponse.ok) {
          const events = await eventsResponse.json();
          document.getElementById('api-events').textContent = `âœ… æ¥ç¶šæˆåŠŸ (${eventsResponse.status})`;
          document.getElementById('events-count').textContent = `${events.length}ä»¶`;
        } else {
          document.getElementById('api-events').textContent = `âŒ ã‚¨ãƒ©ãƒ¼ (${eventsResponse.status})`;
          document.getElementById('events-count').textContent = 'ã‚¨ãƒ©ãƒ¼';
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¹ã‚¯
        const tasksResponse = await fetch(`${API_BASE}/api/local-tasks?userId=${userId}&_t=${Date.now()}`, { cache: 'no-store' });
        if (tasksResponse.ok) {
          const tasks = await tasksResponse.json();
          document.getElementById('api-tasks').textContent = `âœ… æ¥ç¶šæˆåŠŸ (${tasksResponse.status})`;
          document.getElementById('tasks-count').textContent = `${tasks.length}ä»¶`;
        } else {
          document.getElementById('api-tasks').textContent = `âŒ ã‚¨ãƒ©ãƒ¼ (${tasksResponse.status})`;
          document.getElementById('tasks-count').textContent = 'ã‚¨ãƒ©ãƒ¼';
        }

        // ãƒ¡ãƒ¢
        const memosResponse = await fetch(`${API_BASE}/api/memos?userId=${userId}&_t=${Date.now()}`, { cache: 'no-store' });
        if (memosResponse.ok) {
          const memos = await memosResponse.json();
          document.getElementById('api-memos').textContent = `âœ… æ¥ç¶šæˆåŠŸ (${memosResponse.status})`;
          document.getElementById('memos-count').textContent = `${memos.length}ä»¶`;
        } else {
          document.getElementById('api-memos').textContent = `âŒ ã‚¨ãƒ©ãƒ¼ (${memosResponse.status})`;
          document.getElementById('memos-count').textContent = 'ã‚¨ãƒ©ãƒ¼';
        }

        const apiStatus = document.getElementById('api-status');
        apiStatus.className = 'status success';
        const dataStatus = document.getElementById('data-status');
        dataStatus.className = 'status success';

      } catch (error) {
        errors.push('API ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateErrorLog();
        document.getElementById('api-status').className = 'status error';
      }
    }

    function updateErrorLog() {
      const errorLog = document.getElementById('error-log');
      if (errors.length === 0) {
        errorLog.textContent = 'ã‚¨ãƒ©ãƒ¼ãªã—';
        document.getElementById('error-status').className = 'status success';
      } else {
        errorLog.textContent = errors.join('\n');
        document.getElementById('error-status').className = 'status error';
      }
    }

    function clearStorageAndReload() {
      if (confirm('LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.clear();
        location.reload();
      }
    }

    function copyDiagnostics() {
      const diagnostics = `
è¨ºæ–­çµæœ - LINE Calendar Bot
=============================

ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:
- ç¾åœ¨: ${document.getElementById('current-version').textContent}
- ä¿å­˜: ${document.getElementById('stored-version').textContent}
- ä¸€è‡´: ${document.getElementById('version-match').textContent}

LIFFèªè¨¼:
- åˆæœŸåŒ–: ${document.getElementById('liff-init').textContent}
- ãƒ­ã‚°ã‚¤ãƒ³: ${document.getElementById('liff-login').textContent}
- UserID: ${document.getElementById('user-id').textContent}
- åå‰: ${document.getElementById('user-name').textContent}

APIæ¥ç¶š:
- Base: ${document.getElementById('api-base').textContent}
- Events: ${document.getElementById('api-events').textContent}
- Tasks: ${document.getElementById('api-tasks').textContent}
- Memos: ${document.getElementById('api-memos').textContent}

ãƒ‡ãƒ¼ã‚¿:
- Events: ${document.getElementById('events-count').textContent}
- Tasks: ${document.getElementById('tasks-count').textContent}
- Memos: ${document.getElementById('memos-count').textContent}

ã‚¨ãƒ©ãƒ¼:
${document.getElementById('error-log').textContent}
      `.trim();

      navigator.clipboard.writeText(diagnostics).then(() => {
        alert('è¨ºæ–­çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }).catch(() => {
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
        console.log(diagnostics);
      });
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
